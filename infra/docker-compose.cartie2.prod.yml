name: infra
services:
  db:
    image: postgres:15-alpine
    restart: unless-stopped
    env_file:
      - /srv/cartie/env/prod.env
    healthcheck:
      test: ["CMD-SHELL","pg_isready -h 127.0.0.1 -p 5432 -U postgres >/dev/null 2>&1"]
      interval: 5s
      timeout: 3s
      retries: 30
      start_period: 10s
    environment:
      - POSTGRES_USER=cartie
      - POSTGRES_DB=cartie_db
    volumes:
      - /srv/cartie/data/cartie2/postgres:/var/lib/postgresql/data
    ports:
      - "127.0.0.1:5433:5432"
  api:
    restart: unless-stopped
    env_file:
      - /srv/cartie/env/prod.env
    build:
      context: /srv/cartie/apps/cartie2_repo
      dockerfile: infra/Dockerfile.api

    ports:
      - "127.0.0.1:3002:3001"

    healthcheck:
      test: ["CMD-SHELL", "node -e 'const http=require(\"http\"); const req=http.get(\"http://127.0.0.1:3001/health\", r=>process.exit(r.statusCode===200?0:1)); req.on(\"error\", ()=>process.exit(1));'"]
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 10s
    depends_on:
      db:
        condition: service_healthy
  web:
    restart: unless-stopped
    volumes:
      - /srv/cartie/apps/cartie2_repo/infra/Caddyfile:/etc/caddy/Caddyfile:ro
    ports:
      - "127.0.0.1:8082:8080"
    build:
      context: /srv/cartie/apps/cartie2_repo
      dockerfile: infra/Dockerfile.web

    healthcheck:
      test: ["CMD-SHELL","wget -qO- http://127.0.0.1:8080/api/health >/dev/null 2>&1"]
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 10s
    depends_on:
      api:
        condition: service_healthy
