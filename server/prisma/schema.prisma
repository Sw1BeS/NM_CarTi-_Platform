generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum BotTemplate {
  CLIENT_LEAD
  CATALOG
  B2B
}

enum LeadStatus {
  NEW
  IN_PROGRESS
  DONE
  CONTACTED
  WON
  LOST
}

enum RequestStatus {
  DRAFT
  PUBLISHED
  COLLECTING_VARIANTS
  SHORTLIST
  CONTACT_SHARED
  WON
  LOST
}

enum VariantStatus {
  SUBMITTED
  REVIEWED
  APPROVED
  REJECTED
  SENT_TO_CLIENT
}

enum DraftSource {
  EXTENSION
  MANUAL
}

enum ScenarioStatus {
  DRAFT
  PUBLISHED
}

enum NormalizationType {
  brand
  model
  city
}

enum IntegrationType {
  SENDPULSE
  META_PIXEL
  GOOGLE_SHEETS
  WEBHOOK
  ZAPIER
  TELEGRAM_CHANNEL
}

enum CompanyPlan {
  FREE
  PRO
  ENTERPRISE
}

enum UserRole {
  SUPER_ADMIN  // Hidden system admin with full access to all companies
  OWNER
  ADMIN
  MANAGER
  VIEWER
}

// ========================================
// Stage C: Multi-Tenancy Models
// ========================================

model Company {
  id           String      @id @default(cuid())
  name         String
  slug         String      @unique
  logo         String?
  primaryColor String      @default("#D4AF37")
  domain       String?     @unique
  plan         CompanyPlan @default(FREE)
  isActive     Boolean     @default(true)
  
  // Relations
  users        User[]
  bots         BotConfig[]
  scenarios    Scenario[]
  templates    CompanyTemplate[]
  integrations Integration[]
  partnerCompanies PartnerCompany[]
  partnerUsers     PartnerUser[]
  normalizationAliases NormalizationAlias[]
  platformEvents PlatformEvent[]
  
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
}

model ScenarioTemplate {
  id          String   @id @default(cuid())
  name        String
  category    String   // LEAD_GEN, E_COMMERCE, B2B, SUPPORT
  description String
  thumbnail   String?
  isPublic    Boolean  @default(true)
  isPremium   Boolean  @default(false)
  
  // Template structure (nodes, settings)
  structure   Json     @db.JsonB
  
  // Marketplace metadata
  installs    Int      @default(0)
  rating      Float?
  
  // Relations
  installations CompanyTemplate[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model CompanyTemplate {
  id          String           @id @default(cuid())
  companyId   String
  company     Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  templateId  String
  template    ScenarioTemplate @relation(fields: [templateId], references: [id])
  
  installedAt DateTime         @default(now())
  
  @@unique([companyId, templateId])
}

model Integration {
  id        String          @id @default(cuid())
  companyId String
  company   Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  type      IntegrationType
  isActive  Boolean         @default(true)
  
  // Credentials & config
  config    Json            @db.JsonB
  
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt
  
  @@unique([companyId, type])
}

model User {
  id             String   @id @default(cuid())
  email          String   @unique
  password       String
  username       String?
  name           String?
  role           UserRole @default(MANAGER)
  companyId      String
  company        Company  @relation(fields: [companyId], references: [id])
  telegramUserId String?  @unique
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  @@index([companyId])
}


model BotConfig {
  id          String      @id @default(cuid())
  name        String?
  template    BotTemplate
  token       String      @unique
  channelId   String?
  adminChatId String?
  isEnabled   Boolean     @default(true)
  config      Json?       @db.JsonB
  
  companyId   String
  company     Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  sessions    BotSession[]
  campaigns   Campaign[]
  leads       Lead[]
  channelPosts ChannelPost[]
  platformEvents PlatformEvent[]
  telegramUpdates TelegramUpdate[]
  
  @@index([companyId])
}

model Lead {
  id         String     @id @default(cuid())
  leadCode   String?    @unique
  source     String?    // e.g. "BotName" or "Website"
  botId      String?
  bot        BotConfig? @relation(fields: [botId], references: [id])
  
  userTgId   String?
  clientName String
  phone      String?
  request    String?
  status     LeadStatus @default(NEW)
  payload    Json?
  
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt

  activities LeadActivity[]
}

model LeadActivity {
  id        String   @id @default(cuid())
  leadId    String
  lead      Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  type      String
  payload   Json?
  createdAt DateTime @default(now())

  @@index([leadId, createdAt])
}

model B2bRequest {
  id          String           @id @default(cuid())
  publicId    String?          @unique
  title       String           // Extracted from content or manual
  description String?
  budgetMin   Int?
  budgetMax   Int?
  yearMin     Int?
  yearMax     Int?
  city        String?
  language    String?
  
  chatId      String?
  content     String?          // Original raw text
  status      RequestStatus    @default(DRAFT)
  priority    String           @default("NORMAL")
  
  companyId   String?
  assignedTo  String?          // Stage A: Manager assignment
  internalNotes String?        // Stage A: Private notes

  variants    RequestVariant[]
  channelPosts ChannelPost[]
  messages    MessageLog[]
  
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  
  @@index([companyId])
}

model RequestVariant {
  id          String     @id @default(cuid())
  requestId   String
  request     B2bRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)
  
  status      VariantStatus @default(SUBMITTED)
  source      String     @default("MANUAL")
  sourceUrl   String?
  
  title       String?
  price       Int?
  currency    String?    @default("USD")
  year        Int?
  mileage     Int?
  location    String?
  thumbnail   String?
  specs       Json?
  
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  messageLogs MessageLog[]
}


model Draft {
  id          Int         @id @default(autoincrement())
  source      DraftSource
  title       String
  price       String?
  url         String?
  description String?
  status      String      @default("PENDING")
  
  // Stage B: Content Calendar fields
  scheduledAt DateTime?
  postedAt    DateTime?
  destination String?     // 'channel' or 'group'
  botId       String?
  metadata    Json?       @db.JsonB
  
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  
  @@index([scheduledAt, status])
  @@index([postedAt])
}

model CarListing {
  id          String   @id 
  source      String   @default("MANUAL")
  sourceUrl   String?
  title       String
  price       Int
  currency    String   @default("USD")
  year        Int
  mileage     Int
  location    String?
  thumbnail   String?
  mediaUrls   String[]
  specs       Json?
  description String?
  status      String   @default("AVAILABLE") // AVAILABLE, RESERVED, SOLD, PENDING, HIDDEN
  companyId   String?
  postedAt    DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([price])
  @@index([year])
  @@index([status])
  @@index([companyId])
}

model ChannelPost {
  id          String      @id @default(cuid())
  requestId   String
  request     B2bRequest  @relation(fields: [requestId], references: [id], onDelete: Cascade)
  botId       String?
  bot         BotConfig?  @relation(fields: [botId], references: [id])
  channelId   String
  messageId   Int
  status      String      @default("ACTIVE") // ACTIVE, UPDATED, CLOSED
  payload     Json?       @db.JsonB
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  @@unique([requestId, channelId])
  @@index([channelId])
}

model MessageLog {
  id          String      @id @default(cuid())
  requestId   String?
  request     B2bRequest? @relation(fields: [requestId], references: [id], onDelete: SetNull)
  variantId   String?
  variant     RequestVariant? @relation(fields: [variantId], references: [id], onDelete: SetNull)
  botId       String?
  chatId      String
  direction   String      @default("INCOMING")
  text        String?
  payload     Json?       @db.JsonB
  createdAt   DateTime    @default(now())

  @@index([requestId])
  @@index([chatId])
}

model PartnerCompany {
  id        String   @id @default(cuid())
  name      String
  city      String?
  contact   String?
  notes     String?
  companyId String?
  company   Company? @relation(fields: [companyId], references: [id], onDelete: SetNull)

  users     PartnerUser[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model PartnerUser {
  id         String         @id @default(cuid())
  name       String
  telegramId String?        @unique
  phone      String?
  partnerId  String?
  partner    PartnerCompany? @relation(fields: [partnerId], references: [id], onDelete: SetNull)
  companyId  String?
  company    Company?       @relation(fields: [companyId], references: [id], onDelete: SetNull)

  createdAt  DateTime       @default(now())
  updatedAt  DateTime       @updatedAt
}

model BotSession {
  id          String     @id @default(cuid())
  chatId      String
  botId       String
  bot         BotConfig  @relation(fields: [botId], references: [id], onDelete: Cascade)
  
  platform    String     @default("TG")
  state       String     @default("START")
  variables   Json?
  history     Json?
  lastActive  DateTime   @default(now())
  
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  
  @@unique([botId, chatId])
  @@index([lastActive])
}

model NormalizationAlias {
  id        String            @id @default(cuid())
  type      NormalizationType
  alias     String
  canonical String
  companyId String?
  company   Company?          @relation(fields: [companyId], references: [id], onDelete: Cascade)
  createdAt DateTime          @default(now())

  @@unique([type, alias, companyId])
  @@index([type, alias])
  @@index([companyId])
}

model PlatformEvent {
  id        String     @id @default(cuid())
  companyId String?
  company   Company?   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  botId     String?
  bot       BotConfig? @relation(fields: [botId], references: [id], onDelete: SetNull)
  eventType String
  userId    String?
  chatId    String?
  payload   Json?
  createdAt DateTime   @default(now())

  @@index([companyId, createdAt])
  @@index([botId, createdAt])
  @@index([eventType, createdAt])
}

model TelegramUpdate {
  id        String    @id @default(cuid())
  botId     String
  bot       BotConfig @relation(fields: [botId], references: [id], onDelete: Cascade)
  updateId  Int
  payload   Json?
  createdAt DateTime  @default(now())

  @@unique([botId, updateId])
  @@index([createdAt])
}

model Scenario {
  id             String   @id @default(cuid())
  name           String
  triggerCommand String?
  keywords       String[]
  isActive       Boolean  @default(true)
  status         ScenarioStatus @default(PUBLISHED)
  entryNodeId    String?
  nodes          Json
  
  companyId      String
  company        Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  @@index([companyId])
}

model Campaign {
  id             String     @id @default(cuid())
  name           String
  botId          String
  bot            BotConfig  @relation(fields: [botId], references: [id], onDelete: Cascade)
  
  content        Json
  status         String     @default("DRAFT")
  scheduledAt    DateTime?
  stats          Json?
  targetAudience Json?
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt
}

model SystemSettings {
  id           Int      @default(autoincrement()) @id
  autoriaApiKey String?
  metaPixelId   String?
  metaToken     String?
  metaTestCode  String?
  navigation    Json?
  features      Json?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model SystemLog {
  id        Int      @id @default(autoincrement())
  module    String
  action    String
  status    String
  message   String
  payload   Json?
  createdAt DateTime @default(now())
}

//
// --- Dynamic Entities (Variant B) ---
//

enum FieldType {
  text
  number
  boolean
  date
  datetime
  select
  multiselect
  json
}

model EntityDefinition {
  id          String       @id @default(cuid())
  slug        String       @unique
  name        String
  description String?
  status      String       @default("ACTIVE") // ACTIVE | ARCHIVED

  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  fields      EntityField[]
  records     EntityRecord[]
}

model EntityField {
  id          String           @id @default(cuid())
  entityId    String
  entity      EntityDefinition @relation(fields: [entityId], references: [id], onDelete: Cascade)

  key         String
  label       String
  type        FieldType
  required    Boolean          @default(false)
  order       Int              @default(0)

  // optional config (select options, UI hints, validation rules)
  config      Json?            @db.JsonB

  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  @@unique([entityId, key])
  @@index([entityId, order])
}

model EntityRecord {
  id          String           @id @default(cuid())
  entityId    String
  entity      EntityDefinition @relation(fields: [entityId], references: [id], onDelete: Cascade)

  // main payload
  data        Json             @db.JsonB

  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  @@index([entityId, createdAt])
}
